<html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=icon href=/images/favicon-96x96.png><link rel=stylesheet type=text/css href="//fonts.googleapis.com/css?family=Open+Sans"><link rel=stylesheet href=/scss/global.min.ae6b060df7a6cc9d3fc742acd2d5dad1ccc9ba6004fb2b70d30d45768e08f41b.css><link rel=stylesheet href=/css/prism.css><link href="https://fonts.googleapis.com/css?family=Merriweather&display=swap" rel=stylesheet><title>Workflow d'encodage et delivery vidéo avec Temporal | Blog technique e-TF1</title><meta name=description content="Découvrez comment nous avons mis en place notre nouveau workflow d'encodage et de delivery vidéo avec Temporal."><meta name=robots content="index, follow"><meta name=google-site-verification content="8mELmXNpnm-09GtDb3i1kq4Jfq_iR94-yqgo5wN9CdY"><meta property="og:title" content="Workflow d'encodage et delivery vidéo avec Temporal | Blog technique e-TF1"><meta property="og:site_name" content="Blog technique e-TF1"><meta property="og:description" content="Découvrez comment nous avons mis en place notre nouveau workflow d'encodage et de delivery vidéo avec Temporal."><meta property="og:url" content="https://tech.tf1.fr/post/2023/architecture/workflow-video-avec-temporal/"><meta property="og:type" content="website"><meta property="og:locale" content="fr_FR"><meta property="og:image" content="https://tech.tf1.fr/post/2023/architecture/workflow-video-avec-temporal/images/hero.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Workflow d'encodage et delivery vidéo avec Temporal | Blog technique e-TF1"><link rel=canonical href=https://tech.tf1.fr/post/2023/architecture/workflow-video-avec-temporal/><meta name=twitter:description content="Découvrez comment nous avons mis en place notre nouveau workflow d'encodage et de delivery vidéo avec Temporal."><meta name=twitter:image content="https://tech.tf1.fr/post/2023/architecture/workflow-video-avec-temporal/images/hero.jpg"><meta property="article:published_time" content="2023-07-23T09:00:00+00:00"><meta property="article:updated_time" content="2023-07-23T09:00:00+00:00"><meta property="keywords" content="mytf1, tf1, tf1+, streaming, player, video, go, golang, react, js, javascript, css, android, ios, kotlin, swift, nginx, drm, widevine, elemental, aws, mongodb, kafka"><link rel=alternate type=application/rss+xml title="Blog technique e-TF1" href=https://tech.tf1.fr/index.xml></head><body class=line-numbers><script src=/js/initColors.js></script><div class=layout-styled><section class=section><div class=nav-container><a class=logo-link href=/><img src=/images/logo-tf1plus-white.svg alt=logo id=logo-desktop>
<span class=header-hidden>Navigate back to the homepage</span></a><div class=nav-controls><button id=copyButton class=icon-wrapper><svg class="icon-image" width="24" height="20" viewBox="0 0 24 20" fill="none" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" clipRule="evenodd" d="M2 5C2 3.34328 3.34328 2 5 2h9c1.6567.0 3 1.34328 3 3V9c0 1.6567-1.3433 3-3 3H10C9.44771 12 9 12.4477 9 13S9.44771 14 10 14h4c2.7613.0 5-2.2387 5-5V5c0-2.76128-2.2387-5-5-5H5C2.23872.0.0 2.23872.0 5V9c0 1.4938.656313 2.8361 1.6935 3.7509C2.10768 13.1163 2.73961 13.0767 3.10494 12.6625 3.47028 12.2483 3.43068 11.6164 3.0165 11.2511 2.39169 10.6999 2 9.89621 2 9V5zm5 6c0-1.65672 1.34328-3 3-3h4C14.5523 8 15 7.55228 15 7S14.5523 6 14 6H10C7.23872 6 5 8.23872 5 11v4c0 2.7613 2.23872 5 5 5h9c2.7613.0 5-2.2387 5-5V11C24 9.50621 23.3437 8.16393 22.3065 7.24906 21.8923 6.88372 21.2604 6.92332 20.8951 7.3375 20.5297 7.75168 20.5693 8.38361 20.9835 8.74894 21.6083 9.30007 22 10.1038 22 11v4c0 1.6567-1.3433 3-3 3H10c-1.65672.0-3-1.3433-3-3V11z" fill="#000"/></svg><div id=toolTip class=tool-tip>copied</div><input id=copyText style=opacity:0 type=text class=tool-tip></button>
<button id=themeColorButton class=icon-wrapper><div id=sunRays class=sun-rays></div><div id=moonOrSun class=moon-or-sun></div><div id=moonMask class=moon-mask></div></button></div></div></section><script src=/js/toggleLogos.js></script>
<script src=/js/toggleColors.js></script>
<script src=/js/copyUrl.js></script><section class="section narrow"><section id=articleHero class="section narrow"><div class=article-hero><header class=article-header><h1 class=article-hero-heading>Workflow d'encodage et delivery vidéo avec Temporal</h1><div class=article-hero-subtitle><div class=article-meta><a href=/authors/vcomposieux/ class=article-author-link><div class=article-author-avatar><img src=/authors/vcomposieux/avatar.jpg></div><strong>Vincent Composieux</strong>
<span class=hide-on-mobile>,&nbsp;</span></a>
<script src=/js/collapseAuthors.js></script>
Publié le 23 juillet 2023 • 12 minutes</div></div></header><div class=article-hero-image id=ArticleImage__Hero><img src=/post/2023/architecture/workflow-video-avec-temporal/images/hero.jpg></div></div></section><aside id=progressBar class=aside-container><div class=aside-align><div><div class=overlap-container></div></div></div><div class=progress-container tabindex={-1}><div class=track-line aria-hidden=true><div id=progressIndicator class=progress-line></div></div></div></aside><article id=articleContent class=post-content style=position:relative><h2 id=contexte-du-nouveau-workflow>Contexte du nouveau workflow</h2><p>Dans un objectif de faire évoluer et de rendre plus flexible notre workflow d&rsquo;encodage et de mise à disposition de nos flux vidéo (ce que nous appelons le delivery, principalement aux formats Dash et HLS), nous avons souhaités effectuer une refonte applicative de cette partie de notre stack applicative.</p><p>Nous avons commencés par réfléchir à la façon dont nous pourrions découper les différentes tâches que nous effectuons pour l&rsquo;encodage et la mise à disposition de nos vidéos.</p><p>Il était avant tout important de faire un état des lieux des tâches que nous effectuons. Elles sont les suivantes :</p><ul><li>Nous vérifions les fichiers fournis en entrée (fichier vidéo, fichier de sous-titres, &mldr;),</li><li>Nous déplaçons des fichiers sur des espaces de stockages,</li><li>Nous générons des storyboards, une thumbnail et une petite preview de la vidéo,</li><li>Nous effectuons des demandes d&rsquo;encodage à des encodeurs, les interrogons pour obtenir le statut et attendons leur retour,</li><li>Nous générons des clés de DRM auprès des différents fournisseurs (Fairplay, Playready, Widevine),</li><li>Nous construisons un package (fichiers .ismv, .isma, .ism) afin qu&rsquo;ils soient servis par USP Origin,</li><li>Nous envoyons les fichiers produits sur un stockage AWS S3,</li><li>Nous enrichissons une base de données de delivery avec les fichiers produits.</li></ul><p>Toutes ces tâches ne sont pas systématiquement effectuées. Cela dépend en effet du type de vidéo que nous récupérons en entrée, il nous faut donc pouvoir gérer plusieurs workflows.</p><p>L&rsquo;exemple le plus flagrant est celui des vidéos utilisées pour les publicités contre celles utilisées pour la VOD. En effet, les vidéos publicitaires n&rsquo;ont pas de sous-titres, n&rsquo;ont pas besoin de storyboards, thumbnail, preview et de DRM.</p><p>Nous avons donc choisis ce scope des vidéos publicitaires pour commencer notre travail sur ce nouveau workflow et pouvoir livrer rapidement un premier workflow en production.</p><p>Nous avons ensuite mis en place un feature toggle en production afin de servir une petite quantité de vidéo sur le nouveau workflow et monter progressivement en charge sur cette nouvelle version. Cela nous donne la possibilité de revenir rapidement sur l&rsquo;ancien workflow si la moindre anomalie est détectée.</p><h2 id=choix-de-loutil--plusieurs-solutions>Choix de l&rsquo;outil : plusieurs solutions</h2><p>Afin d&rsquo;éviter de devoir développer nous-même un nième outil d&rsquo;orchestration de workflow, nous souhaitions nous appuyer sur un outil fiable, éprouvé, open-source et disposant d&rsquo;une communauté active.</p><p>Nous avons donc étudiés les outils suivants :</p><ul><li><a href=https://conductor.netflix.com/>Conductor</a> : Outil d&rsquo;orchestration de workflow développé par Netflix basé sur de la définition,</li><li><a href=https://cadenceworkflow.io/>Cadence</a> : Outil d&rsquo;orchestration de workflow développé par Uber pour des systèmes distribués,</li><li><a href=https://temporal.io/>Temporal</a> : Outil d&rsquo;orchestration de workflow.</li></ul><p>Nous avons assez rapidement écartés Conductor car cet outil se base sur une définition en JSON des tâches à éxécuter dans les workflows. De plus, la communauté maintenant le SDK Go est assez restreinte.</p><p>Cadence et Temporal sont deux outils assez similaires en terme d&rsquo;utilisation.</p><p>Temporal nous semblait cependant beaucoup plus évolué au niveau de l&rsquo;outillage (CLI, SDK, interface web) et il s&rsquo;agit surtout d&rsquo;un outil avec une société dédiée et une grosse communauté qui nous permet d&rsquo;avoir du support si nécessaire.</p><h2 id=architecture-du-cluster-temporal>Architecture du cluster Temporal</h2><p>Temporal apporte une architecture très intéressante et des briques indépendantes qui vous apporteront une résilience et vous donneront la possibilité d&rsquo;adapter les ressources dont vous aurez besoin.</p><p>En effet, une fois le <a href=https://docs.temporal.io/cluster-deployment-guide>cluster Temporal déployé</a> avec l&rsquo;aide de notre équipe IOPS, celui-ci s&rsquo;occupe de la gestion de nos workflows, sans avoir à avoir connaissance de nos applications (via des workers), qui sont déployées librement et de façon indépendantes.</p><p><img src=images/architecture.svg#darkmode alt=Architecture title=Architecture></p><p>Le cluster Temporal se compose des services suivants :</p><ul><li>Frontend : il s&rsquo;agit du serveur gRPC auquel se connectent les clients (workers, CLI, interface web), s&rsquo;occupe également du rate limiting du routing et de la gestion d&rsquo;autorisations,</li><li>History : il maintient les données des workflows et activités (entrées/sorties et états),</li><li>Matching : il s&rsquo;occupe du dispatch des activités et workflows via la notion de Task Queues,</li><li>Worker : il est utilisé pour la gestion interne des exécutions de workflows,</li><li>Une base de données : il est possible d&rsquo;utiliser MySQL, PostgreSQL ou Cassandra. Vous pourrez aussi utiliser Elasticsearch comme stockage secondaire pour de la recherche.</li></ul><h2 id=architecture-applicative-mise-en-place>Architecture applicative mise en place</h2><p>Nous avons fait le choix d&rsquo;ajouter une API métier devant notre cluster Temporal. La responsabilité de cette API est de piloter l&rsquo;exécution des workflows dans Temporal et également de maintenir un état condensé de l&rsquo;exécution de nos workflows.</p><p>Ainsi, nos clients ne contactent jamais le cluster Temporal en direct mais passent toujours via notre API métier. Ceci nous permet d&rsquo;avoir une zone de sécurité si nous devions effectuer des opérations ou changer d&rsquo;outil par la suite.</p><p>Une fois l&rsquo;API de pilotage et le cluster en place, il ne nous reste plus qu&rsquo;à commencer à déployer nos workers. Un worker est une application qui permet d&rsquo;exécuter une ou plusieurs activités ou un ou plusieurs workflows.</p><h2 id=mise-en-place-des-workers>Mise en place des workers</h2><p>Cette philosophie de workers permet de pouvoir mettre à l&rsquo;échelle efficacement nos applications, en fonction des besoins en ressource ou durée d&rsquo;exécution des tâches qui sont exécutées dans ceux-ci.</p><p><img src=images/workers.svg#darkmode alt=Workers title=Workers></p><p>Dans cet exemple, nous avons quatre workers :</p><ul><li>Un worker &ldquo;Check&rdquo; : Ce worker permet l&rsquo;exécution de deux activités qui nous permettent de vérifier le fichiers vidéo (pistes vidéos / audios, nombre de frames, &mldr;) ainsi que les sous-titres associés (durée cohérente, langue utilisée, &mldr;),</li><li>Un worker &ldquo;Video&rdquo; : Ce worker a plus de besoins en ressources car il exécute des opérations gourmandes afin de générer les storyboards, thumbnails et preview de la vidéo,</li><li>Un worker &ldquo;DRM&rdquo; : Ce worker génère les clés de DRM auprès des différents servides, il est très peu coûteux en ressources,</li><li>Un worker &ldquo;Workflows&rdquo; : Ce worker permet de piloter l&rsquo;exécution des workflows (l&rsquo;ensemble des activités qui doivent être exécutées).</li></ul><p>Bien évidemment, il est possible d&rsquo;organiser les workers comme vous le souhaitez. De notre côté, nous avons fait le choix de les regrouper pour le moment par thématique mais nous pourrons revoir ce point plus tard si le besoin s&rsquo;en fait sentir. C&rsquo;est un point de souplesse important apporté par Temporal.</p><h2 id=implémentation-et-fonctionnalités-de-temporal>Implémentation et fonctionnalités de Temporal</h2><p>Temporal vient avec des SDKs bien fournis pour la plupart des langages. Dans l&rsquo;équipe vidéo, nous utilisons Go et utilisons donc le <a href=https://github.com/temporalio/sdk-go>SDK Go</a> associé.</p><p>Le SDK permet d&rsquo;instancier un worker qui communique via <a href=https://grpc.io/>gRPC</a> avec le frontend du cluster Temporal puis d&rsquo;avoir tous les outils nécessaires à la mise en place des activités et workflows.</p><h3 id=création-dune-activité-et-dun-workflow>Création d&rsquo;une activité et d&rsquo;un workflow</h3><p>Un atout majeur de Temporal vient du fait que le code applicatif est presque complètement découplé du SDK Temporal.</p><p>En effet, nous pouvons écrire simplement l&rsquo;activité suivante :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MyActivity</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>params</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>MyActivityParams</span>,
</span></span><span style=display:flex><span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>MyActivityResult</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Comme on le voit dans cet exemple, l&rsquo;activité est simplement une fonction qui sera exécutée par Temporal lorsqu&rsquo;elle sera enregistrée au worker. Aucun lien avec le SDK Temporal, il serait donc facile de re-utiliser cette fonction ailleurs, comme par exemple dans un autre moteur d&rsquo;orchestration de workflow.</p><p>Nous avons fait le choix d&rsquo;utiliser <a href=https://protobuf.dev/>Protocol Buffers</a> pour la gestion de nos paramètres d&rsquo;entrée et sortie des activités et workflow, cela est bien géré par Temporal et nous permet d&rsquo;avoir de réels contrats d&rsquo;interface pour chaque activité et workflow.</p><p>C&rsquo;est presque pareil pour le code d&rsquo;un workflow, à la seule exception que l&rsquo;argument <code>ctx</code> provient du package workflow du SDK (<code>workflow.Context</code>).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MyWorkflow</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>workflow</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>opts</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>workflow</span>.<span style=color:#a6e22e>ActivityOptions</span>{
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>TaskQueue</span>:              <span style=color:#e6db74>&#34;my-task-queue&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ScheduleToStartTimeout</span>: <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ScheduleToCloseTimeout</span>: <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>StartToCloseTimeout</span>:    <span style=color:#ae81ff>30</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RetryPolicy</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>temporal</span>.<span style=color:#a6e22e>RetryPolicy</span>{
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>InitialInterval</span>:        <span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>BackoffCoefficient</span>:     <span style=color:#ae81ff>1.2</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>MaximumInterval</span>:        <span style=color:#ae81ff>3</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>MaximumAttempts</span>:        <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>NonRetryableErrorTypes</span>: <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>MyActivityResult</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>activityCtx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>workflow</span>.<span style=color:#a6e22e>WithActivityOptions</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>opts</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>workflow</span>.
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ExecuteActivity</span>(<span style=color:#a6e22e>activityCtx</span>, <span style=color:#a6e22e>MyActivity</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>MyActivityParams</span>{}).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>result</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Dans cet exemple, notre workflow exécute une seule activité : <code>MyActivity</code>.</p><p>Point important à souligner, dans notre implémentation, nous avons souhaités :</p><ul><li>Avoir peu de logique dans nos activités : une activité doit s&rsquo;occuper de réaliser une seule et même action,</li><li>Rendre le plus générique possible les activités afin de pouvoir les re-utiliser dans les différents workflows,</li><li>Certaines activités peuvent être optionnelles dans notre workflow, dans ce cas, cela doit être spécifié par un paramètre en entrée afin de garantir le même comportement lors d&rsquo;une re-exécution du workflow.</li></ul><p>Dans le code du workflow ci-dessus, nous avons définis des timeouts pour l&rsquo;exécution de notre activité. Ceux-ci peuvent être définis pour chaque activité, ce qui permet d&rsquo;avoir un contrôle complet sur l&rsquo;exécution. Il est également possible de définir une logique de retry personnalisée pour chaque activité.</p><h3 id=association-à-un-worker>Association à un worker</h3><p>Une fois l&rsquo;activité et le workflow créé, il n&rsquo;y a plus qu&rsquo;à écrire le worker qui exécutera ces fonctions. Rien de plus simple :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Options</span>{})
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#e6db74>&#34;Failed to create Temporal client:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>workerOptions</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>worker</span>.<span style=color:#a6e22e>Options</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TaskQueue</span>: <span style=color:#e6db74>&#34;my-task-queue&#34;</span>,
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>worker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>worker</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>c</span>, <span style=color:#e6db74>&#34;my-namespace&#34;</span>, <span style=color:#a6e22e>workerOptions</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>worker</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>worker</span>.<span style=color:#a6e22e>RegisterActivity</span>(<span style=color:#a6e22e>MyActivity</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>worker</span>.<span style=color:#a6e22e>RegisterWorkflow</span>(<span style=color:#a6e22e>MyWorkflow</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>worker</span>.<span style=color:#a6e22e>Run</span>(<span style=color:#a6e22e>workerOptions</span>)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#e6db74>&#34;Failed to start worker:&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>C&rsquo;est le seul code dont votre worker a besoin pour exécuter cette activité dans ce workflow.</p><p>Comme nous l&rsquo;avons vu précédemment, les workflows et activités à exécuter sont envoyés aux workers en fonction des Task Queues.</p><h3 id=déterminisme>Déterminisme</h3><p>Pour le bon déroulé des workflows, y compris lors de la re-exécution d&rsquo;un workflow, et ainsi éviter des erreurs dûes à des logiques aléatoires et/ou datées dans le temps, Temporal vient avec un aspect <a href=https:/docs.temporal.io/workflows#deterministic-constraints>déterministe</a>.</p><p>Cela signifie que même si l&rsquo;exécution du workflow échoue ou redémarre, le résultat doit rester le même.</p><p>Pour garantir cela, le SDK vient avec un ensemble de méthodes, comme par exemple ici, <code>workflow.Now</code> pour obtenir l&rsquo;heure courante et <code>workflow.GetRandomValue</code> pour générer une valeur aléatoire :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MyWorkflow</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>workflow</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>currentTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>workflow</span>.<span style=color:#a6e22e>Now</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>randomNumber</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>workflow</span>.<span style=color:#a6e22e>GetRandomValue</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=notre-workflow-vod>Notre workflow VOD</h2><p>Notre workflow VOD, le plus complet à ce jour, exécute l&rsquo;ensemble d&rsquo;activités suivantes :</p><p><img src=images/workflow_vod.svg#darkmode alt="Workflow VOD" title="Workflow VOD"></p><p>Comme vous pouvez le voir, il est également possible de paralléliser l&rsquo;exécution de certaines activités, ce qui permet de rendre l&rsquo;exécution du workflow encore plus rapide. C&rsquo;est le cas de nos activités de génération de storyoards et thumbnail.</p><p>Les paramètres d&rsquo;entrée et sortie de notre workflow sont définis via Protobuf comme suit :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>message</span> <span style=color:#a6e22e>VodOttParams</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>string</span> <span style=color:#a6e22e>id</span> = <span style=color:#ae81ff>1</span> [(<span style=color:#a6e22e>validate</span>.<span style=color:#a6e22e>rules</span>).<span style=color:#66d9ef>string</span>.<span style=color:#a6e22e>uuid</span> = <span style=color:#66d9ef>true</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span>.<span style=color:#a6e22e>InputContent</span> <span style=color:#a6e22e>source</span> = <span style=color:#ae81ff>2</span> [(<span style=color:#a6e22e>validate</span>.<span style=color:#a6e22e>rules</span>).<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>required</span> = <span style=color:#66d9ef>true</span>];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>repeated</span> <span style=color:#a6e22e>AudioTrack</span> <span style=color:#a6e22e>audio_tracks</span> = <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>repeated</span> <span style=color:#a6e22e>subtitle</span>.<span style=color:#a6e22e>InputFile</span> <span style=color:#a6e22e>subtitles</span> = <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>is_drm_enabled</span> = <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>caller</span>.<span style=color:#a6e22e>CallParams</span> <span style=color:#a6e22e>callback</span> = <span style=color:#ae81ff>6</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>message</span> <span style=color:#a6e22e>VodOttResult</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>repeated</span> <span style=color:#a6e22e>delivery</span>.<span style=color:#a6e22e>File</span> <span style=color:#a6e22e>delivery_files</span> = <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span>.<span style=color:#a6e22e>OutputContent</span> <span style=color:#a6e22e>thumbnail</span> = <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>source</span>.<span style=color:#a6e22e>OutputContent</span> <span style=color:#a6e22e>preview</span> = <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Lors de la demande d&rsquo;exécution d&rsquo;un workflow, nous avons besoin en entrée de l&rsquo;API des informations suivantes :</p><ul><li>Identifiant de la vidéo</li><li>Emplacement du fichier source (peut-être un fichier sur un système de fichier, HTTP ou encore sur AWS S3),</li><li>Informations sur les pistes audios,</li><li>Informations sur les fichiers de sous-titres associés,</li><li>Savoir si les DRM doivent être activés ou non (cela conditionnera l&rsquo;exécution de l&rsquo;activité de DRM),</li><li>Informations sur une éventuelle callback à effectuer en fin de workflow (cela conditionnera l&rsquo;exécution de l&rsquo;activité de callback).</li></ul><p>En sortie du workflow, nous avons choisis de renvoyer les éléments suivants :</p><ul><li>Informations de fichiers de delivery qui ont été produits par le workflow,</li><li>Emplacement du fichier de thumbnail JPG généré,</li><li>Emplacement du fichier de preview vidéo généré.</li></ul><p>En complément, Temporal permet également via des APIs de récupérer l&rsquo;ensemble des paramètres d&rsquo;entrée et sortie des activités du workflow qui ont été exécutées dans le workflow.</p><p>Nous stockons également ces informations dans notre API de workflow qui nous permet de restituer toutes ces informations au client. Cela permet d&rsquo;apporter des informations supplémentaires lorsque l&rsquo;on souhaite avoir un aperçu complet de ce qui a été exécuté dans notre workflow.</p><h2 id=versioning-et-rétro-compatibilité>Versioning et rétro-compatibilité</h2><p>Lorsque nous faisons évoluer notre workflow ou nos activités, la question de rétro-compatibilité se pose, d&rsquo;autant plus lorsque nous utilisons Protocol Buffers.</p><p>Pour ce qui est des workflow, Temporal vient avec un outillage permettant de conditionner l&rsquo;exécution à l&rsquo;intérieur du workflow en fonction de la version qui est en cours d&rsquo;exécution.</p><p>Ainsi, il est possible d&rsquo;ajouter un (ou plusieurs) tag de version dans le code du workflow via la ligne suivante :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>version</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>workflow</span>.<span style=color:#a6e22e>GetVersion</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;Version-20230630-1&#34;</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>)
</span></span></code></pre></div><p>Nous pouvons ensuite conditionner l&rsquo;exécution d&rsquo;une activité comme suit :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>version</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>mediaCheckResult</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>executeMediaCheck</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>workflowResult</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(
</span></span><span style=display:flex><span>				<span style=color:#e6db74>&#34;when running mcheck activity: %w&#34;</span>, <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>			)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#75715e>// Nous ne voulons plus exécuter cette activité en version 2.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span></code></pre></div><p>Cette solution pouvant devenir rapidement compliquer à suivre, il peut aussi nous arriver de dupliquer le workflow en le suffixant <code>V2</code>. Ainsi, lorsque tous les workflow en version 1 seront terminés, nous pourrons simplement supprimer le code applicatif du workflow version 1.</p><p>Nous utilisons la même logique de duplication pour les changements qui ne seraient pas rétro-compatibles sur les activités.</p><h2 id=métriques-et-observabilité>Métriques et observabilité</h2><p>Le cluster Temporal et son SDK viennent également avec leur lot de métriques et d&rsquo;outillage <a href=https://opentelemetry.io/>Open-Telemetry</a>.</p><p>Côté métriques, simplement en implémentant le SDK, vous pourrez alors ainsi récupérer beaucoup d&rsquo;informations. Nous conseillons de suivre principalement les métriques suivantes :</p><ul><li>Activité : Tracking du temps d&rsquo;attente du statut &ldquo;schedule&rdquo; à &ldquo;start&rdquo; (<code>activity_schedule_to_start_latency</code>),</li><li>Activité : Temps d&rsquo;exécution des activités : celle-ci est importante pour donner une idée du temps d&rsquo;exécution et ainsi adapter les timeouts (<code>activity_execution_latency</code>),</li><li>Activité : Exécutions en échec (<code>activity_execution_failed</code>),</li><li>Workflow : Temps d&rsquo;exécution total du workflow (<code>workflow_endtoend_latency</code>),</li><li>Workflow : Exécutions en échec ou complétés avec succès (<code>workflow_completed</code> et <code>workflow_failed</code>),</li><li>Worker : Slots disponibles pour l&rsquo;exécution de tâches (<code>worker_task_slots_available</code>).</li></ul><p>Nous utilisons Datadog comme plateforme d&rsquo;observabilité pour notre infrastructure, nos logs et aussi nos traces applicatives.</p><p>Le SDK de Temporal permet également d&rsquo;envoyer des traces pour chaque activité de notre workflow :</p><p><img src=images/tracing.jpg#darkmode alt="Open-Telemetry Tracing" title="Open-Telemetry Tracing"></p><h2 id=conclusion>Conclusion</h2><p>La mise en place de Temporal dans notre architecture applicative était un réel succès et nous a apporté un meilleur contrôle sur l&rsquo;ensemble de nos tâches ainsi qu&rsquo;une meilleure visibilité sur leur exécution.</p><p>Nous avons pu commencer notre étude en installant simplement le binaire <a href=https://github.com/temporalio/temporalite>temporalite</a> qui permet de faire tourner un cluster allégé, ce qui est super pour commencer à tester l&rsquo;outil.</p><p>La réflexion effectuée en amont et le fait d&rsquo;avoir rendu les activités le plus générique possible nous a permis une très grande ré-utilisation sur l&rsquo;ensemble de nos workflows et ainsi gagner en temps de développement sur la mise en place des workflows suivants.</p><h2 id=crédits>Crédits</h2><p>L&rsquo;image utilisée pour illustrer cet article est fournie par <a href=https://unsplash.com/fr/photos/XhzGiOXw8yE>Jamie Street</a>.</p></article><section id=articleNext class="section nartrow"><h3 class=footer-next-heading>Plus d'articles</h3><div class=footer-spacer></div><div class=next-articles-grid numberofarticles={numberOfArticles}><div class=post-row><a href=/post/2023/cdm/ class=article-link id=article-link-bigger><div><div class=image-container><img src=https://photos.tf1.fr/1280/0/cover-hp-ott-135c2c-26558e-0@1x.png class=article-image></div><div><h2 class=article-title>Coupe du Monde : dans les coulisses de MYTF1</h2><p class=article-excerpt>De l’architecture applicative aux CDN en passant par la sécurité, la Coupe du Monde a mis à l’épreuve tous les pans de l’infrastructure de MYTF1.</p><div class=article-metadata>17 mars 2023 • 8 minutes</div></div></div></a><a href=/post/2022/architecture/abonnement-multi-plateforme/ class=article-link><div><div class=image-container><img src=/post/2022/architecture/abonnement-multi-plateforme/images/hero.jpg class=article-image></div><div><h2 class=article-title>Mise en place de notre système d'abonnement multi-plateforme</h2><p class=article-excerpt>Découvrez comment nous avons mis en place une gestion d'abonnements multi-platforme pour notre offre MYTF1 MAX.</p><div class=article-metadata>14 mars 2022 • 10 minutes</div></div></div></a></div></div></section></section><script src=/js/progressBar.js></script><div class=footer-gradient></div><div class="section narrow"><div class=footer-hr></div><div class=footer-container><div class=footer-text><img src=/images/logo_tf1lg.png class=footer-logo>TF1 Copyright © 2025 e-TF1</div><div class=social-icon-outer><div class=social-icon-container><a href=https://www.welcometothejungle.com/fr/companies/groupe-tf1><svg class="social-icon-image" viewBox="7 7 26 26" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" alt="Rejoingez nous !" title="Rejoignez nous !"><path d="M31.347322 11.295661C30.1466441 9.31125424 26.6585085 8.44345763 24.1202034 11.0048136 23.9785085 11.1532881 23.7913898 11.6054915 24.3554576 12.2149831c1.181017 1.258305 7.340339 7.7179661 5.0616949 13.36-1.1071186 2.7430508-4.2555932 2.2705084-5.438644-2.2738984C23.4991864 21.4590508 22.7595254 17.6326102 23.468678 13.0393898 23.468678 13.0393898 23.5818983 12.6082034 23.3995254 12.4705763 23.2734237 12.3743051 23.0707119 12.4143051 22.8103729 12.8312542 22.7452881 12.936339 22.7588475 12.9146441 22.6964746 13.0265085L22.6924068 13.0285424c-1.7457627 2.9444068-3.5220339 6.4352542-4.3579661 7.7444068C18.7425763 18.7980339 18.2252881 16.0814237 17.4185085 13.8075254L17.2666441 13.396678C16.5215593 11.4515932 15.6259661 10.1390508 15.3541017 9.84142373 15.3215593 9.80549153 15.2408814 9.73837288 14.9744407 9.73837288H7.42461017c-.528135590000001.0-.4820339.45220342-.31525424.615593219999999 2.00474576 2.3857627 7.84610167 11.3294915 5.13762717 20.1064407C12.0381695 31.1390508 12.3663051 31.4949831 12.9066441 30.7946441c2.3742373-3.0772882 5.32-8.3227119 7.4542373-12.2542373C19.8903729 19.9037966 19.4761356 21.4217627 19.2544407 23.0122712c-.4677966 3.3572881.5247457 5.8827119 1.2508474 7.2081356C20.8768136 30.8990508 21.3696949 31.3139661 22.6456271 31.1241356c6.5071187-.9694915 8.6772882-6.7016949 9.4786441-9.6088136C33.5852881 16.215661 32.5154576 13.2258305 31.347322 11.295661" id="monogram" fill="#000"/></svg></a><span class=hidden>https://www.welcometothejungle.com/fr/companies/groupe-tf1</span>
<a href=https://www.linkedin.com/company/e-tf1/><svg class="social-icon-image" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" clipRule="evenodd" d="M3.59615 13.125H.871552V4.36523H3.59615V13.125zM2.24847 3.16406c-.42969.0-.80078-.15625-1.11328-.46875-.312498-.3125-.468747-.6836-.468747-1.11328.0-.42969.156249-.800782.468747-1.113281C1.44769.156249 1.81878.0 2.24847.0s.80078.156249 1.11328.468749c.3125.312499.46875.683591.46875 1.113281.0.42968-.15625.80078-.46875 1.11328s-.68359.46875-1.11328.46875zM13.7915 13.125H11.0669V8.84765C11.0669 8.14452 11.0083 7.63671 10.8911 7.32421c-.2148-.52734-.6348-.79101-1.25976-.79101-.625.0-1.06445.23437-1.31836.70312C8.11767 7.58788 8.02001 8.10546 8.02001 8.78905V13.125H5.32471V4.36523H7.93212V5.5664H7.96142C8.15673 5.17578 8.46923 4.85351 8.89892 4.59961c.46875-.3125 1.01562-.46875 1.64058-.46875 1.2696.0 2.1582.40039 2.666 1.20117C13.5962 5.97656 13.7915 6.97265 13.7915 8.3203V13.125z" fill="#73737d"/></svg></a><span class=hidden>https://www.linkedin.com/company/e-tf1/</span>
<a href=https://github.com/etf1><svg class="social-icon-image" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" clipRule="evenodd" d="M7 0C3.1325.0.0 3.21173.0 7.17706.0 10.3529 2.00375 13.0353 4.78625 13.9863 5.13625 14.0491 5.2675 13.8338 5.2675 13.6454 5.2675 13.4749 5.25875 12.9097 5.25875 12.3087 3.5 12.6406 3.045 11.8691 2.905 11.4653 2.82625 11.259 2.485 10.622 2.1875 10.4516 1.9425 10.317 1.5925 9.98508 2.17875 9.97611 2.73 9.96714 3.12375 10.4964 3.255 10.7118c.63 1.0855 1.63625.7805 2.03875.5921C5.355 10.8374 5.53875 10.5234 5.74 10.3439 4.1825 10.1645 2.555 9.54549 2.555 6.80026c0-.7805.27125-1.42644.7175-1.92883C3.2025 4.692 2.9575 3.95635 3.3425 2.96951c0 0 .58625-.1884 1.925.73565.56-.16149 1.155-.24223 1.75-.24223s1.19.08074 1.75.24223c1.3388-.93302 1.925-.73565 1.925-.73565C11.0775 3.95635 10.8325 4.692 10.7625 4.87143 11.2087 5.37382 11.48 6.01079 11.48 6.80026c0 2.7542-1.63625 3.36424-3.19375 3.54364C8.54 10.5682 8.75875 10.9988 8.75875 11.6717 8.75875 12.6316 8.75 13.4032 8.75 13.6454 8.75 13.8338 8.88125 14.0581 9.23125 13.9863 11.9963 13.0353 14 10.3439 14 7.17706 14 3.21173 10.8675.0 7 0z" fill="#73737d"/></svg></a><span class=hidden>https://github.com/etf1</span>
<a href=https://tech.tf1.fr/index.xml><svg class="social-icon-image" style="width:1em;height:1em;vertical-align:middle;fill:currentColor;overflow:hidden" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M329.142857 768q0 45.714286-32 77.714286t-77.714286 32-77.714285-32-32-77.714286 32-77.714286 77.714285-32 77.714286 32 32 77.714286zm292.571429 70.285714q1.142857 16-9.714286 27.428572-10.285714 12-26.857143 12H508q-14.285714.0-24.571429-9.428572T472 844.571429q-12.571429-130.857143-105.428571-223.714286T142.857143 515.428571Q128.571429 514.285714 119.142857 504T109.714286 479.428571V402.285714q0-16.571429 12-26.857143 9.714286-9.714286 24.571428-9.714285h2.857143q91.428571 7.428571 174.857143 46T472 515.428571q65.142857 64.571429 103.714286 148t46 174.857143zm292.571428 1.142857Q915.428571 854.857142 904 866.285714q-10.285714 11.428571-26.285714 11.428572H796q-14.857143.0-25.428571-10t-11.142858-24.285715Q752.571428 720.571428 701.714286 610T569.428571 418t-192-132.285714T144 227.428571q-14.285714-.571429-24.285714-11.142857t-10-24.857143V109.714286q0-16 11.428571-26.285715 10.285714-10.285714 25.142857-10.285714H148q149.714286 7.428571 286.571429 68.571429t243.142857 168q106.857143 106.285714 168 243.142857t68.571428 286.571428z"/></svg></a><span class=hidden>https://tech.tf1.fr/index.xml</span></div></div></div></div></div><script src=/js/prism.js></script></body></html>